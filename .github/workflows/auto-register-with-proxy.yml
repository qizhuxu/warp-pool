name: Auto Register Warp Account (With Proxy)

# ============================================
# ğŸ“ é…ç½®åŒºåŸŸ - ä¿®æ”¹é»˜è®¤å€¼è¯·åœ¨æ­¤å¤„ä¿®æ”¹
# ============================================
env:
  DEFAULT_REGISTER_COUNT: 6      # é»˜è®¤æ³¨å†Œè´¦å·æ•°é‡
  DEFAULT_MAX_FAILS: 6            # é»˜è®¤æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      register_count:
        description: 'æ³¨å†Œè´¦å·æ•°é‡'
        required: false
        default: '6'
        type: string
      max_fails:
        description: 'æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°'
        required: false
        default: '6'
        type: string

jobs:
  register:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Secrets Configuration and Service Health
        run: |
          echo "=========================================="
          echo "  æ­¥éª¤ 1: æ£€æŸ¥ Secrets é…ç½®"
          echo "=========================================="
          
          # æ£€æŸ¥ Firebase API Keyï¼ˆå¿…éœ€ï¼‰
          if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
            echo "âŒ FIREBASE_API_KEY æœªé…ç½®"
            echo "è¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  FIREBASE_API_KEY"
            exit 1
          else
            echo "âœ… FIREBASE_API_KEY å·²é…ç½®"
          fi
          
          # æ£€æŸ¥ä»£ç†é…ç½®ï¼ˆå¿…éœ€ï¼‰
          if [ -z "${{ secrets.XRAY_PROXY_URL }}" ]; then
            echo "âŒ XRAY_PROXY_URL æœªé…ç½®"
            echo "è¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ  XRAY_PROXY_URL"
            echo "æ ¼å¼ç¤ºä¾‹: vmess://base64encodedconfig æˆ– vless://config"
            exit 1
          else
            echo "âœ… XRAY_PROXY_URL å·²é…ç½®"
          fi
          
          # æ£€æŸ¥é‚®ç®±æœåŠ¡é…ç½®
          HAS_MOEMAIL=false
          HAS_SKYMAIL=false
          MOEMAIL_URL="${{ secrets.MOEMAIL_URL }}"
          SKYMAIL_URL="${{ secrets.SKYMAIL_URL }}"
          
          if [ -n "${{ secrets.MOEMAIL_API_KEY }}" ]; then
            HAS_MOEMAIL=true
            echo "âœ… MoeMail å·²é…ç½®"
            
            # è®¾ç½®é»˜è®¤ URL
            if [ -z "$MOEMAIL_URL" ]; then
              MOEMAIL_URL="https://email.959585.xyz"
              echo "   â„¹ï¸  MOEMAIL_URL æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼: $MOEMAIL_URL"
            else
              echo "   â„¹ï¸  MOEMAIL_URL: $MOEMAIL_URL"
            fi
          fi
          
          if [ -n "${{ secrets.SKYMAIL_TOKEN }}" ]; then
            HAS_SKYMAIL=true
            echo "âœ… Skymail å·²é…ç½®"
            
            if [ -z "$SKYMAIL_URL" ]; then
              echo "   âš ï¸  SKYMAIL_URL æœªé…ç½®ï¼ŒSkymail å¯èƒ½æ— æ³•ä½¿ç”¨"
            else
              echo "   â„¹ï¸  SKYMAIL_URL: $SKYMAIL_URL"
            fi
            
            if [ -n "${{ secrets.SKYMAIL_DOMAIN }}" ]; then
              echo "   â„¹ï¸  SKYMAIL_DOMAIN: ${{ secrets.SKYMAIL_DOMAIN }}"
            else
              echo "   â„¹ï¸  SKYMAIL_DOMAIN æœªé…ç½®ï¼Œå°†ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤åŸŸå"
            fi
          fi
          
          # è‡³å°‘éœ€è¦ä¸€ä¸ªé‚®ç®±æœåŠ¡
          if [ "$HAS_MOEMAIL" = false ] && [ "$HAS_SKYMAIL" = false ]; then
            echo ""
            echo "âŒ è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªé‚®ç®±æœåŠ¡"
            echo ""
            echo "è¯·é…ç½®ä»¥ä¸‹ Secrets ä¹‹ä¸€ï¼š"
            echo "  - MOEMAIL_API_KEY (MoeMail æœåŠ¡)"
            echo "  - SKYMAIL_TOKEN (Skymail æœåŠ¡)"
            echo ""
            echo "æ¨èé…ç½®ä¸¤ä¸ªæœåŠ¡ä»¥å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "  é…ç½®æ£€æŸ¥å®Œæˆ"
          echo "=========================================="
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Xray Proxy
        id: proxy
        run: |
          echo "=========================================="
          echo "  æ­¥éª¤ 2: é…ç½® Xray ä»£ç†"
          echo "=========================================="
          
          # ä¸‹è½½ Xray æ ¸å¿ƒ
          echo "ğŸ“¥ ä¸‹è½½ Xray æ ¸å¿ƒ..."
          XRAY_VERSION="1.8.23"
          wget -q "https://github.com/XTLS/Xray-core/releases/download/v25.10.15/Xray-linux-64.zip"
          unzip -q Xray-linux-64.zip -d xray
          chmod +x xray/xray
          
          echo "âœ… Xray æ ¸å¿ƒä¸‹è½½å®Œæˆ"
          ./xray/xray version
          
          # è§£æä»£ç† URL
          echo ""
          echo "ğŸ”§ è§£æä»£ç†é…ç½®..."
          PROXY_URL="${{ secrets.XRAY_PROXY_URL }}"
          
          # åˆ›å»º Xray é…ç½®æ–‡ä»¶
          cat > xray/config.json << 'EOF'
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "port": 10808,
                "protocol": "socks",
                "settings": {
                  "auth": "noauth",
                  "udp": true
                },
                "sniffing": {
                  "enabled": true,
                  "destOverride": ["http", "tls"]
                }
              },
              {
                "port": 10809,
                "protocol": "http",
                "settings": {}
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "tag": "direct"
              }
            ]
          }
          EOF
          
          # æ ¹æ®ä»£ç†ç±»å‹ç”Ÿæˆé…ç½®
          if [[ "$PROXY_URL" == vmess://* ]]; then
            echo "ğŸ“¡ æ£€æµ‹åˆ° VMess åè®®"
            # è§£ç  VMess URL
            VMESS_JSON=$(echo "$PROXY_URL" | sed 's/vmess:\/\///' | base64 -d)
            
            # æå–é…ç½®ä¿¡æ¯
            ADDRESS=$(echo "$VMESS_JSON" | jq -r '.add')
            PORT=$(echo "$VMESS_JSON" | jq -r '.port')
            UUID=$(echo "$VMESS_JSON" | jq -r '.id')
            ALTERID=$(echo "$VMESS_JSON" | jq -r '.aid // 0')
            NETWORK=$(echo "$VMESS_JSON" | jq -r '.net // "tcp"')
            
            echo "   æœåŠ¡å™¨: $ADDRESS:$PORT"
            echo "   ç½‘ç»œç±»å‹: $NETWORK"
            
            # æ·»åŠ  VMess outbound
            jq '.outbounds = [
              {
                "protocol": "vmess",
                "settings": {
                  "vnext": [{
                    "address": "'$ADDRESS'",
                    "port": '$PORT',
                    "users": [{
                      "id": "'$UUID'",
                      "alterId": '$ALTERID',
                      "security": "auto"
                    }]
                  }]
                },
                "streamSettings": {
                  "network": "'$NETWORK'"
                },
                "tag": "proxy"
              },
              {
                "protocol": "freedom",
                "tag": "direct"
              }
            ]' xray/config.json > xray/config.tmp && mv xray/config.tmp xray/config.json
            
          elif [[ "$PROXY_URL" == vless://* ]]; then
            echo "ğŸ“¡ æ£€æµ‹åˆ° VLESS åè®®"
            
            # è§£æ VLESS URL
            VLESS_PART=$(echo "$PROXY_URL" | sed 's/vless:\/\///')
            UUID=$(echo "$VLESS_PART" | cut -d'@' -f1)
            SERVER_PART=$(echo "$VLESS_PART" | cut -d'@' -f2)
            ADDRESS=$(echo "$SERVER_PART" | cut -d':' -f1)
            PORT=$(echo "$SERVER_PART" | cut -d':' -f2 | cut -d'?' -f1)
            
            # è§£ææŸ¥è¯¢å‚æ•°
            QUERY_STRING=$(echo "$PROXY_URL" | grep -oP '\?.*' | sed 's/^?//')
            
            # æå–å‚æ•°
            SECURITY=$(echo "$QUERY_STRING" | grep -oP 'security=\K[^&]+' || echo "none")
            SNI=$(echo "$QUERY_STRING" | grep -oP 'sni=\K[^&]+' || echo "")
            TYPE=$(echo "$QUERY_STRING" | grep -oP 'type=\K[^&]+' || echo "tcp")
            HOST=$(echo "$QUERY_STRING" | grep -oP 'host=\K[^&]+' || echo "")
            PATH=$(echo "$QUERY_STRING" | grep -oP 'path=\K[^&]+' || echo "/")
            # URL è§£ç  path
            PATH=$(echo "$PATH" | sed 's/%2F/\//g' | sed 's/%3F/?/g' | sed 's/%3D/=/g')
            
            echo "   æœåŠ¡å™¨: $ADDRESS:$PORT"
            echo "   ä¼ è¾“åè®®: $TYPE"
            echo "   å®‰å…¨: $SECURITY"
            if [ -n "$SNI" ]; then
              echo "   SNI: $SNI"
            fi
            if [ "$TYPE" = "ws" ]; then
              echo "   WebSocket Host: $HOST"
              echo "   WebSocket Path: $PATH"
            fi
            
            # æ„å»º streamSettings
            STREAM_SETTINGS='{"network": "'$TYPE'"'
            
            # æ·»åŠ  TLS é…ç½®
            if [ "$SECURITY" = "tls" ]; then
              STREAM_SETTINGS="$STREAM_SETTINGS"', "security": "tls", "tlsSettings": {"serverName": "'$SNI'", "allowInsecure": false}'
            fi
            
            # æ·»åŠ  WebSocket é…ç½®
            if [ "$TYPE" = "ws" ]; then
              STREAM_SETTINGS="$STREAM_SETTINGS"', "wsSettings": {"path": "'$PATH'", "headers": {"Host": "'$HOST'"}}'
            fi
            
            STREAM_SETTINGS="$STREAM_SETTINGS"'}'
            
            # æ·»åŠ  VLESS outbound
            jq --argjson stream "$STREAM_SETTINGS" '.outbounds = [
              {
                "protocol": "vless",
                "settings": {
                  "vnext": [{
                    "address": "'$ADDRESS'",
                    "port": '$PORT',
                    "users": [{
                      "id": "'$UUID'",
                      "encryption": "none",
                      "flow": ""
                    }]
                  }]
                },
                "streamSettings": $stream,
                "tag": "proxy"
              },
              {
                "protocol": "freedom",
                "tag": "direct"
              }
            ]' xray/config.json > xray/config.tmp && mv xray/config.tmp xray/config.json
            
          else
            echo "âŒ ä¸æ”¯æŒçš„ä»£ç†åè®®"
            echo "æ”¯æŒçš„åè®®: vmess://, vless://"
            exit 1
          fi
          
          # å¯åŠ¨ Xray
          echo ""
          echo "ğŸš€ å¯åŠ¨ Xray ä»£ç†..."
          ./xray/xray run -c xray/config.json > xray.log 2>&1 &
          XRAY_PID=$!
          echo "xray_pid=$XRAY_PID" >> $GITHUB_OUTPUT
          
          # ç­‰å¾…ä»£ç†å¯åŠ¨
          sleep 3
          
          # éªŒè¯ä»£ç†æ˜¯å¦æ­£å¸¸è¿è¡Œ
          if ps -p $XRAY_PID > /dev/null; then
            echo "âœ… Xray ä»£ç†å·²å¯åŠ¨ (PID: $XRAY_PID)"
          else
            echo "âŒ Xray ä»£ç†å¯åŠ¨å¤±è´¥"
            cat xray.log
            exit 1
          fi
          
          # æµ‹è¯•ä»£ç†è¿æ¥
          echo ""
          echo "ğŸ” æµ‹è¯•ä»£ç†è¿æ¥..."
          
          # æµ‹è¯•å¤šä¸ªç›®æ ‡ä»¥æé«˜æˆåŠŸç‡
          TEST_PASSED=false
          
          # æµ‹è¯• 1: Cloudflare DNS
          if curl -x socks5://127.0.0.1:10808 -s --max-time 10 https://1.1.1.1 > /dev/null 2>&1; then
            echo "âœ… ä»£ç†æµ‹è¯•é€šè¿‡ (Cloudflare)"
            TEST_PASSED=true
          fi
          
          # æµ‹è¯• 2: GitHub (å¦‚æœç¬¬ä¸€ä¸ªå¤±è´¥)
          if [ "$TEST_PASSED" = false ]; then
            if curl -x socks5://127.0.0.1:10808 -s --max-time 10 https://api.github.com > /dev/null 2>&1; then
              echo "âœ… ä»£ç†æµ‹è¯•é€šè¿‡ (GitHub)"
              TEST_PASSED=true
            fi
          fi
          
          # æµ‹è¯• 3: Warp ç½‘ç«™ (å¦‚æœå‰ä¸¤ä¸ªéƒ½å¤±è´¥)
          if [ "$TEST_PASSED" = false ]; then
            if curl -x socks5://127.0.0.1:10808 -s --max-time 10 https://app.warp.dev > /dev/null 2>&1; then
              echo "âœ… ä»£ç†æµ‹è¯•é€šè¿‡ (Warp)"
              TEST_PASSED=true
            fi
          fi
          
          if [ "$TEST_PASSED" = true ]; then
            echo "proxy_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  ä»£ç†è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†å°†ç»§ç»­æ‰§è¡Œ"
            echo "   å¯èƒ½åŸå› ï¼š"
            echo "   1. ä»£ç†æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨"
            echo "   2. ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜"
            echo "   3. ç›®æ ‡ç½‘ç«™è¢«é˜»æ–­"
            echo ""
            echo "   æŸ¥çœ‹ Xray æ—¥å¿—ï¼š"
            tail -20 xray.log || echo "   (æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨)"
            echo "proxy_status=warning" >> $GITHUB_OUTPUT
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "HTTP_PROXY=http://127.0.0.1:10809" >> $GITHUB_ENV
          echo "HTTPS_PROXY=http://127.0.0.1:10809" >> $GITHUB_ENV
          echo "ALL_PROXY=socks5://127.0.0.1:10808" >> $GITHUB_ENV
          echo "NO_PROXY=localhost,127.0.0.1,::1" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… ä»£ç†é…ç½®å®Œæˆ"
          echo "   SOCKS5: 127.0.0.1:10808"
          echo "   HTTP: 127.0.0.1:10809"
          echo "=========================================="
      
      - name: Randomize Machine ID
        run: |
          echo "=== ä¿®æ”¹æœºå™¨ç  ==="
          
          # 1. ç”Ÿæˆéšæœºçš„ machine-idï¼ˆä½¿ç”¨ openssl æ›´å¯é ï¼‰
          RANDOM_MACHINE_ID=$(openssl rand -hex 16)
          echo "æ–°çš„ machine-id: $RANDOM_MACHINE_ID"
          
          # ä¿®æ”¹ /etc/machine-id
          echo "$RANDOM_MACHINE_ID" | sudo tee /etc/machine-id > /dev/null
          
          # ä¿®æ”¹ /var/lib/dbus/machine-idï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f /var/lib/dbus/machine-id ]; then
            echo "$RANDOM_MACHINE_ID" | sudo tee /var/lib/dbus/machine-id > /dev/null
          fi
          
          # 2. ç”Ÿæˆéšæœºçš„ hostname
          RANDOM_SUFFIX=$(openssl rand -hex 4)
          RANDOM_HOSTNAME="gh-runner-${RANDOM_SUFFIX}"
          echo "æ–°çš„ hostname: $RANDOM_HOSTNAME"
          sudo hostname "$RANDOM_HOSTNAME"
          echo "$RANDOM_HOSTNAME" | sudo tee /etc/hostname > /dev/null
          
          # 3. æ¸…ç†å¯èƒ½ç¼“å­˜æœºå™¨ä¿¡æ¯çš„æ–‡ä»¶
          sudo rm -rf /var/lib/systemd/random-seed 2>/dev/null || true
          rm -rf ~/.cache/* 2>/dev/null || true
          
          # éªŒè¯ä¿®æ”¹
          echo "=== éªŒè¯æœºå™¨ç  ==="
          echo "machine-id: $(cat /etc/machine-id)"
          echo "hostname: $(hostname)"
          
          echo "âœ… æœºå™¨ç ä¿®æ”¹å®Œæˆ"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xvfb
          
          # å®Œå…¨å¸è½½æ—§ç‰ˆæœ¬ Chrome å’Œ Chromium
          sudo apt-get remove -y google-chrome-stable chromium-browser chromium || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ Chrome æ–‡ä»¶
          sudo rm -rf /opt/google/chrome || true
          sudo rm -rf ~/.config/google-chrome || true
          
          # å®‰è£…æœ€æ–°ç‰ˆ Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          
          # éªŒè¯å®‰è£…
          echo "=== Chrome å®‰è£…ä¿¡æ¯ ==="
          google-chrome --version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # æ¸…ç† ChromeDriver ç¼“å­˜
          rm -rf ~/.undetected_chromedriver
          rm -rf /tmp/.com.google.Chrome.*
      
      - name: Download previous accounts
        id: download
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE_TAG=$(date -u '+%Y-%m-%d')
          echo "date_tag=$DATE_TAG" >> $GITHUB_OUTPUT
          
          # å°è¯•ä¸‹è½½ä»Šå¤©çš„ all_accounts.json
          if gh release view "$DATE_TAG" >/dev/null 2>&1; then
            echo "ğŸ“¥ å‘ç°ä»Šå¤©çš„ releaseï¼Œä¸‹è½½ç°æœ‰è´¦å·æ•°æ®..."
            
            # ä¸‹è½½å¹¶è§£å‹
            gh release download "$DATE_TAG" -p "all_accounts.json" 2>/dev/null || true
            
            if [ -f "all_accounts.json" ]; then
              # åˆ›å»ºç›®å½•å¹¶ç§»åŠ¨æ–‡ä»¶
              mkdir -p "accounts/$DATE_TAG"
              mv all_accounts.json "accounts/$DATE_TAG/"
              
              OLD_COUNT=$(jq '. | length' "accounts/$DATE_TAG/all_accounts.json")
              echo "ğŸ“Š å·²ä¸‹è½½ç°æœ‰è´¦å·: $OLD_COUNT ä¸ª"
              echo "old_count=$OLD_COUNT" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸  ä»Šå¤©çš„ release ä¸­æ²¡æœ‰ all_accounts.json"
              echo "old_count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  ä»Šå¤©è¿˜æ²¡æœ‰ releaseï¼Œä»é›¶å¼€å§‹"
            echo "old_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure environment
        run: |
          # æ£€æµ‹é…ç½®äº†å“ªäº›é‚®ç®±æœåŠ¡
          HAS_MOEMAIL=false
          HAS_SKYMAIL=false
          
          if [ -n "${{ secrets.MOEMAIL_API_KEY }}" ]; then
            HAS_MOEMAIL=true
            echo "âœ… æ£€æµ‹åˆ° MoeMail é…ç½®"
          fi
          
          if [ -n "${{ secrets.SKYMAIL_TOKEN }}" ]; then
            HAS_SKYMAIL=true
            echo "âœ… æ£€æµ‹åˆ° Skymail é…ç½®"
          fi
          
          # è‡³å°‘éœ€è¦ä¸€ä¸ªé‚®ç®±æœåŠ¡
          if [ "$HAS_MOEMAIL" = false ] && [ "$HAS_SKYMAIL" = false ]; then
            echo "âŒ è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªé‚®ç®±æœåŠ¡ï¼ˆMOEMAIL_API_KEY æˆ– SKYMAIL_TOKENï¼‰"
            exit 1
          fi
          
          # ç¡®å®š EMAIL_SERVICE æ¨¡å¼
          if [ "$HAS_MOEMAIL" = true ] && [ "$HAS_SKYMAIL" = true ]; then
            EMAIL_SERVICE="auto"
            echo "ğŸ² ä¸¤ä¸ªé‚®ç®±æœåŠ¡éƒ½å·²é…ç½®ï¼Œä½¿ç”¨ auto æ¨¡å¼ï¼ˆè‡ªåŠ¨é€‰æ‹© + æ•…éšœè½¬ç§»ï¼‰"
          elif [ "$HAS_MOEMAIL" = true ]; then
            EMAIL_SERVICE="moemail"
            echo "ğŸ“§ ä½¿ç”¨ MoeMail æœåŠ¡"
          else
            EMAIL_SERVICE="skymail"
            echo "ğŸ“§ ä½¿ç”¨ Skymail æœåŠ¡"
          fi
          
          # éªŒè¯ Firebase API Key
          if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
            echo "âŒ FIREBASE_API_KEY æœªé…ç½®"
            exit 1
          fi
          
          # åˆ›å»º .env æ–‡ä»¶
          cat > .env << EOF
          EMAIL_SERVICE=$EMAIL_SERVICE
          MOEMAIL_URL=${{ secrets.MOEMAIL_URL || 'https://email.959585.xyz' }}
          MOEMAIL_API_KEY=${{ secrets.MOEMAIL_API_KEY }}
          SKYMAIL_URL=${{ secrets.SKYMAIL_URL || '' }}
          SKYMAIL_TOKEN=${{ secrets.SKYMAIL_TOKEN || '' }}
          SKYMAIL_DOMAIN=${{ secrets.SKYMAIL_DOMAIN || '' }}
          SKYMAIL_WILDCARD=${{ secrets.SKYMAIL_WILDCARD || 'false' }}
          FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          WARP_LOGIN_URL=https://app.warp.dev/referral/EWP6QD
          HEADLESS=true
          FINGERPRINT_RANDOMIZE=true
          FINGERPRINT_LEVEL=balanced
          ENHANCED_PROFILES_ENABLED=true
          STRICT_CONSISTENCY_CHECK=true
          FINGERPRINT_DEBUG=false
          EMAIL_TIMEOUT=120
          REGISTER_COUNT=1
          REGISTER_INTERVAL=5
          EOF
          
          echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"
      
      - name: Batch registration
        id: register
        continue-on-error: true
        run: |
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p accounts debug
          
          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          google-chrome --version
          python --version
          echo "ä»£ç†çŠ¶æ€: ${{ steps.proxy.outputs.proxy_status }}"
          
          # éªŒè¯ä»£ç†æ˜¯å¦ä»åœ¨è¿è¡Œ
          if ps -p ${{ steps.proxy.outputs.xray_pid }} > /dev/null; then
            echo "âœ… Xray ä»£ç†è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸  Xray ä»£ç†å·²åœæ­¢ï¼Œå°è¯•é‡å¯..."
            ./xray/xray run -c xray/config.json > xray.log 2>&1 &
            sleep 2
          fi
          
          # è·å–æ—§è´¦å·æ•°
          OLD_COUNT="${{ steps.download.outputs.old_count }}"
          echo "ğŸ“Š å·²æœ‰è´¦å·æ•°: $OLD_COUNT"
          
          # è·å–æ³¨å†Œå‚æ•°ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶å¯è‡ªå®šä¹‰ï¼Œå®šæ—¶ä»»åŠ¡ä½¿ç”¨ç¯å¢ƒå˜é‡é»˜è®¤å€¼ï¼‰
          if [ -n "${{ github.event.inputs.register_count }}" ]; then
            REGISTER_COUNT="${{ github.event.inputs.register_count }}"
          else
            REGISTER_COUNT="${{ env.DEFAULT_REGISTER_COUNT }}"
          fi
          
          if [ -n "${{ github.event.inputs.max_fails }}" ]; then
            MAX_FAILS="${{ github.event.inputs.max_fails }}"
          else
            MAX_FAILS="${{ env.DEFAULT_MAX_FAILS }}"
          fi
          
          echo "ğŸ“ æ³¨å†Œå‚æ•°ï¼š"
          echo "  - æ³¨å†Œæ•°é‡: $REGISTER_COUNT"
          echo "  - æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°: $MAX_FAILS"
          echo "  - ä»£ç†æ¨¡å¼: Xray (SOCKS5 + HTTP)"
          
          # ä½¿ç”¨æ‰¹é‡æ³¨å†Œè„šæœ¬
          echo "ğŸš€ å¼€å§‹æ‰¹é‡æ³¨å†Œï¼ˆç›®æ ‡å¢åŠ  $REGISTER_COUNT ä¸ªè´¦å·ï¼‰..."
          xvfb-run -a python batch_register.py --add "$REGISTER_COUNT" --headless true --max-fails "$MAX_FAILS" 2>&1 | tee registration.log
          
          # ä¿å­˜é€€å‡ºç 
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥ all_accounts.json æ˜¯å¦å­˜åœ¨
          DATE_TAG="${{ steps.download.outputs.date_tag }}"
          ALL_ACCOUNTS_FILE="accounts/$DATE_TAG/all_accounts.json"
          
          if [ -f "$ALL_ACCOUNTS_FILE" ]; then
            # ç»Ÿè®¡æ€»è´¦å·æ•°å’Œæ–°å¢æ•°
            TOTAL_COUNT=$(jq '. | length' "$ALL_ACCOUNTS_FILE")
            ADDED_COUNT=$((TOTAL_COUNT - OLD_COUNT))
            
            # è®¡ç®—æˆåŠŸç‡
            if [ $REGISTER_COUNT -gt 0 ]; then
              SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", ($ADDED_COUNT / $REGISTER_COUNT) * 100}")
            else
              SUCCESS_RATE="0.0"
            fi
            
            echo "ğŸ“Š æ–°å¢è´¦å·æ•°: $ADDED_COUNT"
            echo "ğŸ“Š æ€»è´¦å·æ•°: $TOTAL_COUNT"
            echo "ğŸ“Š æˆåŠŸç‡: ${SUCCESS_RATE}%"
            echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
            echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            
            if [ $ADDED_COUNT -gt 0 ]; then
              echo "account_created=true" >> $GITHUB_OUTPUT
              echo "âœ… æ‰¹é‡æ³¨å†Œå®Œæˆï¼Œæ–°å¢ $ADDED_COUNT ä¸ªè´¦å·ï¼ˆæˆåŠŸç‡: ${SUCCESS_RATE}%ï¼‰"
            else
              echo "account_created=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ æœªæˆåŠŸæ³¨å†Œæ–°è´¦å·"
            fi
          else
            echo "account_created=false" >> $GITHUB_OUTPUT
            echo "added_count=0" >> $GITHUB_OUTPUT
            echo "total_count=$OLD_COUNT" >> $GITHUB_OUTPUT
            echo "success_rate=0.0" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ° all_accounts.json æ–‡ä»¶"
          fi
      
      - name: Prepare release data
        if: steps.register.outputs.account_created == 'true'
        id: prepare
        run: |
          DATE_TAG="${{ steps.download.outputs.date_tag }}"
          ALL_ACCOUNTS_FILE="accounts/$DATE_TAG/all_accounts.json"
          
          # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$ALL_ACCOUNTS_FILE" ]; then
            echo "âŒ all_accounts.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤åˆ¶åˆ°æ ¹ç›®å½•æ–¹ä¾¿ä¸Šä¼ 
          cp "$ALL_ACCOUNTS_FILE" ./all_accounts.json
          echo "âœ… å·²å‡†å¤‡ all_accounts.json"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          ADDED_COUNT="${{ steps.register.outputs.added_count }}"
          TOTAL_COUNT="${{ steps.register.outputs.total_count }}"
          OLD_COUNT="${{ steps.download.outputs.old_count }}"
          SUCCESS_RATE="${{ steps.register.outputs.success_rate }}"
          
          cat > release-notes.md << EOF
          # ğŸ“… $(date -u '+%Y-%m-%d') è´¦å·æ•°æ® (With Proxy)
          
          ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          - â• æœ¬æ¬¡æ–°å¢: **${ADDED_COUNT}** ä¸ªè´¦å·
          - ğŸ“¦ ä»Šæ—¥æ€»è®¡: **${TOTAL_COUNT}** ä¸ªè´¦å·
          - ğŸ“‹ ä¹‹å‰å·²æœ‰: **${OLD_COUNT}** ä¸ªè´¦å·
          - ğŸ“ˆ æˆåŠŸç‡: **${SUCCESS_RATE}%**
          - ğŸŒ ä»£ç†æ¨¡å¼: **Xray (SOCKS5 + HTTP)**
          - â° æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          ä¸‹è½½ \`all_accounts.json\` æ–‡ä»¶å³å¯è·å–ä»Šæ—¥æ‰€æœ‰è´¦å·æ•°æ®ï¼ˆç´¯è®¡ï¼‰ã€‚
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - [æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [æŸ¥çœ‹æ‰€æœ‰å‘å¸ƒ](https://github.com/${{ github.repository }}/releases)
          
          ---
          ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | æ¯å°æ—¶è‡ªåŠ¨æ›´æ–° | ä½¿ç”¨ Xray ä»£ç†
          EOF
          
          echo "âœ… å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
      
      - name: Create or update daily release
        if: steps.register.outputs.account_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE_TAG="${{ steps.download.outputs.date_tag }}"
          
          # æ£€æŸ¥ä»Šå¤©çš„ release æ˜¯å¦å·²å­˜åœ¨
          if gh release view "$DATE_TAG" >/dev/null 2>&1; then
            echo "ğŸ“ æ›´æ–°ç°æœ‰ release: $DATE_TAG"
            
            # åˆ é™¤æ—§çš„ all_accounts.json
            gh release delete-asset "$DATE_TAG" "all_accounts.json" --yes 2>/dev/null || true
            
            # ä¸Šä¼ æ–°çš„ all_accounts.json
            gh release upload "$DATE_TAG" "all_accounts.json" --clobber
            
            # æ›´æ–° release è¯´æ˜
            gh release edit "$DATE_TAG" --notes-file release-notes.md
            
            echo "âœ… Release å·²æ›´æ–°ï¼ˆç´¯è®¡ ${{ steps.register.outputs.total_count }} ä¸ªè´¦å·ï¼ŒæˆåŠŸç‡ ${{ steps.register.outputs.success_rate }}%ï¼‰"
          else
            echo "ğŸ†• åˆ›å»ºæ–° release: $DATE_TAG"
            
            # åˆ›å»ºæ–° release
            gh release create "$DATE_TAG" \
              "all_accounts.json" \
              --title "ğŸ“… Accounts - $DATE_TAG (Proxy)" \
              --notes-file release-notes.md
            
            echo "âœ… Release å·²åˆ›å»º"
          fi
      
      - name: Cleanup old releases
        if: steps.register.outputs.account_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ§¹ æ¸…ç† 7 å¤©å‰çš„ releases..."
          
          # è®¡ç®— 7 å¤©å‰çš„æ—¥æœŸ
          CUTOFF_DATE=$(date -u -d '7 days ago' '+%Y-%m-%d' 2>/dev/null || date -u -v-7d '+%Y-%m-%d')
          echo "æ¸…ç†æ—¥æœŸé˜ˆå€¼: $CUTOFF_DATE"
          
          # è·å–æ‰€æœ‰ release æ ‡ç­¾
          gh release list --limit 100 | while read -r line; do
            TAG=$(echo "$line" | awk '{print $1}')
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦æ˜¯æ—¥æœŸæ ¼å¼ (YYYY-MM-DD)
            if [[ "$TAG" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              # æ¯”è¾ƒæ—¥æœŸ
              if [[ "$TAG" < "$CUTOFF_DATE" ]]; then
                echo "ğŸ—‘ï¸  åˆ é™¤æ—§ release: $TAG"
                gh release delete "$TAG" --yes --cleanup-tag
              fi
            fi
          done
          
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: Cleanup Xray
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç† Xray è¿›ç¨‹..."
          if [ -n "${{ steps.proxy.outputs.xray_pid }}" ]; then
            kill ${{ steps.proxy.outputs.xray_pid }} 2>/dev/null || true
            echo "âœ… Xray è¿›ç¨‹å·²åœæ­¢"
          fi
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-proxy-${{ github.run_number }}
          path: |
            registration.log
            xray.log
            debug/*.png
          retention-days: 7
          if-no-files-found: ignore
