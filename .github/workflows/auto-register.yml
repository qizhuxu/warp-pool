name: Auto Register Warp Account

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  register:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Randomize Machine ID
        run: |
          echo "=== ä¿®æ”¹æœºå™¨ç  ==="
          
          # 1. ç”Ÿæˆéšæœºçš„ machine-idï¼ˆä½¿ç”¨ openssl æ›´å¯é ï¼‰
          RANDOM_MACHINE_ID=$(openssl rand -hex 16)
          echo "æ–°çš„ machine-id: $RANDOM_MACHINE_ID"
          
          # ä¿®æ”¹ /etc/machine-id
          echo "$RANDOM_MACHINE_ID" | sudo tee /etc/machine-id > /dev/null
          
          # ä¿®æ”¹ /var/lib/dbus/machine-idï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f /var/lib/dbus/machine-id ]; then
            echo "$RANDOM_MACHINE_ID" | sudo tee /var/lib/dbus/machine-id > /dev/null
          fi
          
          # 2. ç”Ÿæˆéšæœºçš„ hostname
          RANDOM_SUFFIX=$(openssl rand -hex 4)
          RANDOM_HOSTNAME="gh-runner-${RANDOM_SUFFIX}"
          echo "æ–°çš„ hostname: $RANDOM_HOSTNAME"
          sudo hostname "$RANDOM_HOSTNAME"
          echo "$RANDOM_HOSTNAME" | sudo tee /etc/hostname > /dev/null
          
          # 3. æ¸…ç†å¯èƒ½ç¼“å­˜æœºå™¨ä¿¡æ¯çš„æ–‡ä»¶
          sudo rm -rf /var/lib/systemd/random-seed 2>/dev/null || true
          rm -rf ~/.cache/* 2>/dev/null || true
          
          # éªŒè¯ä¿®æ”¹
          echo "=== éªŒè¯æœºå™¨ç  ==="
          echo "machine-id: $(cat /etc/machine-id)"
          echo "hostname: $(hostname)"
          
          echo "âœ… æœºå™¨ç ä¿®æ”¹å®Œæˆ"
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xvfb jq
          
          # å®Œå…¨å¸è½½æ—§ç‰ˆæœ¬ Chrome å’Œ Chromium
          sudo apt-get remove -y google-chrome-stable chromium-browser chromium || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ Chrome æ–‡ä»¶
          sudo rm -rf /opt/google/chrome || true
          sudo rm -rf ~/.config/google-chrome || true
          
          # å®‰è£…æœ€æ–°ç‰ˆ Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          
          # éªŒè¯å®‰è£…
          echo "=== Chrome å®‰è£…ä¿¡æ¯ ==="
          google-chrome --version
          which google-chrome
          ls -la /usr/bin/google-chrome*
      
      - name: Install Python dependencies
        run: |
          cd warp-pool
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # æ¸…ç† ChromeDriver ç¼“å­˜
          rm -rf ~/.undetected_chromedriver
          rm -rf /tmp/.com.google.Chrome.*
      
      - name: Configure environment
        run: |
          cd warp-pool
          
          # ä» GitHub Secrets åˆ›å»º .env æ–‡ä»¶
          cat > .env << EOF
          FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          MOEMAIL_API_KEY=${{ secrets.MOEMAIL_API_KEY }}
          PROXY_URL=${{ secrets.PROXY_URL }}
          HEADLESS=true
          MAX_RETRIES=3
          TIMEOUT=60
          EOF
          
          echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
      
      - name: Test proxy connection
        run: |
          cd warp-pool
          
          python -c "
          import os
          from dotenv import load_dotenv
          import httpx
          
          load_dotenv()
          proxy = os.getenv('PROXY_URL')
          
          if proxy:
              try:
                  client = httpx.Client(proxy=proxy, timeout=10.0, verify=False)
                  response = client.get('https://api.ipify.org?format=json')
                  print(f'âœ… ä»£ç†å¯ç”¨ï¼Œå‡ºå£IP: {response.json()[\"ip\"]}')
              except Exception as e:
                  print(f'âŒ ä»£ç†æµ‹è¯•å¤±è´¥: {e}')
                  exit(1)
          else:
              print('âš ï¸ æœªé…ç½®ä»£ç†ï¼Œå°†ä½¿ç”¨ç›´è¿')
          "
      
      - name: Run registration
        id: register
        run: |
          cd warp-pool
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p accounts debug
          
          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          google-chrome --version
          python --version
          
          # è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "=== å°è¯• $ATTEMPT/$MAX_ATTEMPTS ==="
            
            if xvfb-run -a python register.py --headless true 2>&1 | tee registration_attempt_$ATTEMPT.log; then
              if ls accounts/*.json 1>/dev/null 2>&1; then
                SUCCESS=true
                echo "âœ… æ³¨å†ŒæˆåŠŸ"
                break
              fi
            fi
            
            echo "âŒ å°è¯• $ATTEMPT å¤±è´¥"
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "ç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          if [ "$SUCCESS" = true ]; then
            echo "account_created=true" >> $GITHUB_OUTPUT
          else
            echo "account_created=false" >> $GITHUB_OUTPUT
            echo "âŒ æ‰€æœ‰å°è¯•å‡å¤±è´¥"
            exit 1
          fi
      
      - name: Commit accounts
        if: steps.register.outputs.account_created == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          # ç§»åŠ¨è´¦å·æ–‡ä»¶åˆ°æ ¹ç›®å½•çš„ accounts/
          if ls warp-pool/accounts/*.json 1>/dev/null 2>&1; then
            mkdir -p accounts
            mv warp-pool/accounts/*.json accounts/
          fi
          
          git add accounts/*.json
          
          if ! git diff --staged --quiet; then
            ACCOUNT_COUNT=$(ls accounts/*.json 2>/dev/null | wc -l)
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ğŸ¤– Auto-register: New account at $TIMESTAMP (Total: $ACCOUNT_COUNT)"
            git push
          else
            echo "âš ï¸ æ²¡æœ‰æ–°è´¦å·éœ€è¦æäº¤"
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: registration-run-${{ github.run_number }}
          path: |
            warp-pool/accounts/*.json
            warp-pool/registration.log
            warp-pool/debug/*.png
          retention-days: 30
          if-no-files-found: ignore
