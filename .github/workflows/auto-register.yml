name: Auto Register Warp Account

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  register:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xvfb
          
          # å®Œå…¨å¸è½½æ—§ç‰ˆæœ¬ Chrome å’Œ Chromium
          sudo apt-get remove -y google-chrome-stable chromium-browser chromium || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„ Chrome æ–‡ä»¶
          sudo rm -rf /opt/google/chrome || true
          sudo rm -rf ~/.config/google-chrome || true
          
          # å®‰è£…æœ€æ–°ç‰ˆ Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          
          # éªŒè¯å®‰è£…
          echo "=== Chrome å®‰è£…ä¿¡æ¯ ==="
          google-chrome --version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # æ¸…ç† ChromeDriver ç¼“å­˜
          rm -rf ~/.undetected_chromedriver
          rm -rf /tmp/.com.google.Chrome.*
      
      - name: Configure environment
        run: |
          # åˆ›å»º .env æ–‡ä»¶
          cat > .env << EOF
          MOEMAIL_URL=${{ secrets.MOEMAIL_URL || 'https://email.959585.xyz' }}
          MOEMAIL_API_KEY=${{ secrets.MOEMAIL_API_KEY }}
          FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          WARP_LOGIN_URL=https://app.warp.dev/login
          HEADLESS=true
          FINGERPRINT_RANDOMIZE=true
          FINGERPRINT_LEVEL=balanced
          ENHANCED_PROFILES_ENABLED=true
          STRICT_CONSISTENCY_CHECK=true
          FINGERPRINT_DEBUG=false
          EMAIL_TIMEOUT=120
          REGISTER_COUNT=1
          REGISTER_INTERVAL=5
          EOF
          
          # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "${{ secrets.MOEMAIL_API_KEY }}" ]; then
            echo "âŒ MOEMAIL_API_KEY æœªé…ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
            echo "âŒ FIREBASE_API_KEY æœªé…ç½®"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒé…ç½®å®Œæˆ"
      
      - name: Run registration
        id: register
        continue-on-error: true
        run: |
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p accounts debug
          
          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          google-chrome --version
          python --version
          
          # ä½¿ç”¨ xvfb-run è¿è¡Œæ³¨å†Œ
          echo "å¼€å§‹æ³¨å†Œ..."
          xvfb-run -a python register.py --headless true 2>&1 | tee registration.log
          
          # ä¿å­˜é€€å‡ºç 
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆè´¦å·ï¼ˆæ£€æŸ¥æ—¥æœŸç›®å½•ï¼‰
          TODAY=$(date +%Y-%m-%d)
          if [ -d "accounts/$TODAY" ] && [ -n "$(ls -A accounts/$TODAY/*.json 2>/dev/null)" ]; then
            echo "account_created=true" >> $GITHUB_OUTPUT
            
            # è·å–æœ€æ–°è´¦å·ä¿¡æ¯
            LATEST_ACCOUNT=$(ls -t accounts/$TODAY/*.json 2>/dev/null | grep -v all_accounts.json | head -1)
            if [ -n "$LATEST_ACCOUNT" ]; then
              EMAIL=$(python -c "import json; print(json.load(open('$LATEST_ACCOUNT'))['email'])" 2>/dev/null || echo "unknown")
              echo "latest_email=$EMAIL" >> $GITHUB_OUTPUT
            fi
            
            echo "âœ… æ³¨å†ŒæˆåŠŸ"
          else
            echo "account_created=false" >> $GITHUB_OUTPUT
            echo "âŒ æ³¨å†Œå¤±è´¥"
          fi
      
      - name: Commit accounts
        if: steps.register.outputs.account_created == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          # æ·»åŠ æ•´ä¸ª accounts ç›®å½•
          git add accounts/
          
          if ! git diff --staged --quiet; then
            # ç»Ÿè®¡æ€»è´¦å·æ•°
            TOTAL_COUNT=$(find accounts -name "*.json" -not -name "all_accounts.json" | wc -l)
            EMAIL="${{ steps.register.outputs.latest_email }}"
            
            git commit -m "ğŸ¤– Auto-register: New account $EMAIL

            ğŸ“Š Total accounts: $TOTAL_COUNT
            â° Time: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
            ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            git push
            echo "âœ… è´¦å·æ–‡ä»¶å·²æäº¤"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ–‡ä»¶éœ€è¦æäº¤"
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: registration-run-${{ github.run_number }}
          path: |
            accounts/**/*.json
            registration.log
            debug/*.png
          retention-days: 30
          if-no-files-found: ignore